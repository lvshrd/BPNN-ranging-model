# Improvement of Range Estimation Model for Presence Check System based on BP Neural Network

The system originally adopted a simple Shadowing model, where RSSI values were obtained by scanning surrounding devices through the mobile end. These values were then input into a simple coefficient pending equation to calculate the logarithmic loss formula of A (RSSI value at reference distance) and n (environmental factor), as detailed in relevant literature, to obtain distance values. 

Due to the questionable accuracy of this method, a decision was made to collect datasets based on BP neural networks in two scenarios: open environments and environments obstructed by walls. Outliers were removed, and a weighted blending filter was applied. Subsequently, two regression prediction models were constructed. An environment switching algorithm was designed to switch between prediction models based on sudden changes in RSSI values, with the aim of significantly improving accuracy.

## Model Deployment

Considering the real-time and convenience aspects of the ranging algorithm, the improved ranging model is deployed on a web end based on Flask server (lvshrd.pythonanywhere.com/predict). 

This deployment is more efficient and secure compared to importing model files into an Android app and using corresponding APIs for prediction. This eliminates the need to rewrite RSSI data processing, filtering, and normalization in the app. Moreover, compared to local area network deployment, this deployment allows for 24/7 access from anywhere.

## Theoretical Results

Compared to the fitted Shadowing model, the BP-based ranging model demonstrates better performance under two conditions:

| Metric       | Shadowing Model (env0) | BP Model (env0) | Shadowing Model (env1) | BP Model (env1) |
|--------------|-------------------------|------------------|-------------------------|------------------|
| RMSE         | 2.016                   | 1.530            | 1.839                   | 1.525            |
| MAE          | 1.673                   | 1.136            | 1.424                   | 1.200            |
| R^2 Score    | 0.523                   | 0.725            | 0.600                   | 0.725            |

## Project Directory Structure

### Datasets
- `data_env_0`: Dataset for scenarios with wall obstruction.
- `data_env_1`: Dataset for open indoor scenes.
   Each scene contains files numbered from 1 to 10, each file containing a fixed number of RSSI data points.

   Due to imperfect data collection functionality in the app, samples were collected roughly based on time, which may result in inconsistent frequency and quantity. Therefore, they all undergo sample quantity alignment in the `test` directory through the `dataNumber_align.py` script.

- `data_env_2`: Randomly generated dataset for data visualization and model testing purposes, generated by the `data_generation.py` script in the `test` directory.

### Models
- `model`: Location of model files generated by the `BPmodel.py` script, with each model file corresponding to the respective dataset.

### Flask Related Files
- `flask_server.py`: Server deployment file for local area network, to be uploaded to PythonAnywhere as a web server. The model file paths need to be modified accordingly. `flask_server.log` logs the runtime process of `flask_server.py`.
- `templates`: Contains `index.html`, the UI interface for the Flask server's default `@app.route('/')`.
- `flask_test_client.py`: Utilizes Tkinter to implement a graphical client for testing the server, dynamically sending custom RSSI values at a fixed frequency.

### Model Handling Scripts
- `BPmodel.py`: Main program implementing model construction and visualization of test set predictions. 
- `BP_copy.py`: Temporary file for debugging `BPmodel.py`, primarily for testing the effects of different filtering parameters.

### Data Processing
- `dataFormat.json`: Defines the data exchange format for communication between Flask server and app for range model prediction.
- `filter.py`: Defines the `clean_rssi_values` method for removing outliers, and various filters including `gaussian_filter`, `moving_average_filter`, `kalman_filter`, `alpha_beta_gama_filter`, `median_filter`, and `weighted_blend_filter`.
